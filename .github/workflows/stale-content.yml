name: üìÖ Stale Content Check

on:
  schedule:
    - cron: '0 9 1 * *'  # 1st of every month at 9am UTC
  workflow_dispatch:

jobs:
  stale-check:
    runs-on: ubuntu-latest
    name: Flag Outdated Playbooks & Intel

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git log dates

      - name: Check playbook freshness
        run: |
          echo "üìÖ Checking playbook freshness (threshold: 90 days)..."
          THRESHOLD=90
          NOW=$(date +%s)
          STALE=()

          for dir in playbooks/*/; do
            LAST_COMMIT=$(git log -1 --format="%at" -- "$dir" 2>/dev/null)
            if [ -z "$LAST_COMMIT" ]; then
              continue
            fi
            DAYS_OLD=$(( (NOW - LAST_COMMIT) / 86400 ))
            DIRNAME=$(basename "$dir")
            if [ "$DAYS_OLD" -gt "$THRESHOLD" ]; then
              STALE+=("‚ö†Ô∏è  $DIRNAME ‚Äî last updated ${DAYS_OLD} days ago")
            else
              echo "‚úÖ $DIRNAME ‚Äî updated ${DAYS_OLD} days ago"
            fi
          done

          if [ ${#STALE[@]} -gt 0 ]; then
            echo ""
            echo "üìã Playbooks that may need review:"
            for item in "${STALE[@]}"; do
              echo "  $item"
            done
            echo ""
            echo "üí° Consider reviewing these for updated TTPs, new IOCs, or revised response steps."
          else
            echo ""
            echo "‚úÖ All playbooks are within the freshness threshold."
          fi
