name: üîç Validate IOCs

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-iocs:
    runs-on: ubuntu-latest
    name: Check IOC Format & Defanging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install iocextract

      - name: Scan for undefanged IPs in markdown files
        run: |
          echo "üîé Scanning for undefanged IOCs..."
          python3 - <<'PYEOF'
          import os, re, sys

          # Patterns that indicate a live (non-defanged) IOC
          ip_pattern = re.compile(r'\b(?!10\.|192\.168\.|172\.\d+\.|127\.)\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b')
          defanged_ok = re.compile(r'\[\.\]')  # defanged pattern is fine

          issues = []
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in ['.git', 'node_modules']]
              for fname in files:
                  if fname.endswith('.md'):
                      fpath = os.path.join(root, fname)
                      with open(fpath, 'r', errors='ignore') as f:
                          for i, line in enumerate(f, 1):
                              # Skip lines that are code comments or already defanged
                              if defanged_ok.search(line):
                                  continue
                              # Skip lines in code blocks that are clearly detection rules
                              if any(kw in line for kw in ['dst_ip', 'src_ip', 'NOT IN', 'whitelist', 'IN (']):
                                  continue
                              matches = ip_pattern.findall(line)
                              for ip in matches:
                                  issues.append(f"  ‚ö†Ô∏è  {fpath}:{i} ‚Äî Possible undefanged IP: {ip}")

          if issues:
              print("‚ùå Potential undefanged IOCs found:")
              for issue in issues:
                  print(issue)
              print("\nüí° Tip: Replace '.' with '[.]' in IOC addresses (e.g., 1.2.3[.]4)")
              sys.exit(1)
          else:
              print("‚úÖ All IOCs appear properly defanged.")
          PYEOF

      - name: Check .php.sample naming convention
        run: |
          echo "üîé Checking malware samples are defanged..."
          live_php=$(find . -name "*.php" ! -name "*.php.sample" 2>/dev/null | grep -v ".git")
          if [ -n "$live_php" ]; then
            echo "‚ùå Live PHP files found (should be renamed to .php.sample):"
            echo "$live_php"
            exit 1
          else
            echo "‚úÖ All PHP samples are properly defanged (.php.sample)."
          fi
